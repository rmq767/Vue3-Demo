var j=Object.defineProperty;var z=(o,t,e)=>t in o?j(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var _=(o,t,e)=>z(o,typeof t!="symbol"?t+"":t,e);import{x as G,a as N}from"./element-plus-DRy_UtcF.js";import{d as D,I as A,o as C,F as O,J as g,a as d,c as R,L as W,P as y,r as M,s as q,e as J,al as H,R as m,a8 as K,a9 as Q,O as w,n as X}from"./@vue-DtXbQ2UY.js";import{_ as k}from"./plugin-vueexport-helper-DlAUqK2U.js";import{M as B,D as T,W as P,V as U,z as v,A as Y,j as Z,E as ee}from"./@codemirror-Dh08W_7j.js";import{b as te}from"./codemirror-32XRi9wL.js";import"./lodash-es-CVJ_Bk8S.js";import"./@vueuse-ZySg_D90.js";import"./@element-plus-dWmgPpBK.js";import"./@sxzz-D_chPuIy.js";import"./@ctrl-r5W6hzzQ.js";import"./dayjs-B7BNuc5J.js";import"./@turf-n0MF4LHv.js";import"./async-validator-9PlIezaS.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-D0iZPv2f.js";import"./@lezer-yanOjkoW.js";import"./style-mod-Bc2inJdb.js";import"./crelt-C8TCjufn.js";import"./@marijn-DXwl3gUT.js";import"./w3c-keyname-Vcq4gwWv.js";const oe=["onMouseenter"],se={key:0,class:"desc"},ne={name:"Tree"},ae=D({...ne,props:{data:{default:()=>[]}},emits:["mouseenter"],setup(o,{emit:t}){const e=o,s=t,a=p=>{s("mouseenter",p)};return(p,x)=>{const i=G;return C(),A(i,O({style:{"max-width":"600px"},data:e.data},p.$attrs),{default:g(({node:f,data:r})=>[d("div",{class:"tree-node",onMouseenter:u=>a(r)},[d("span",null,y(r.label),1),r.desc?(C(),R("span",se,y(r.desc),1)):W("",!0)],40,oe)]),_:1},16,["data"])}}}),S=k(ae,[["__scopeId","data-v-9ecb9895"]]),ie={class:"desc"},re={class:"title"},ce={class:"example"},le={class:"description"},de={name:"Desc"},pe=D({...de,props:{title:{type:String,default:""},example:{type:String,default:""},description:{type:String,default:""}},setup(o){const t=o;return(e,s)=>(C(),R("div",ie,[d("h4",re,y(t.title),1),d("p",ce,y(t.example),1),d("p",le,y(t.description),1)]))}}),ue=k(pe,[["__scopeId","data-v-59c8cf75"]]),V=new B({regexp:/\[\[(.+?)\]\]/g,decoration:o=>T.replace({widget:new me(o[1])})});class me extends P{constructor(e){super();_(this,"id","");_(this,"text","");if(e){const[s,...a]=e.split(".");s&&a.length&&(this.text=a.join("."),this.id=s,console.log(this.text,"id:",this.id))}}eq(e){return this.text==e.text}toDOM(){let e=document.createElement("span");return this.text&&(e.className="cm-tag",e.textContent=this.text),e}ignoreEvent(){return!0}}const fe=U.fromClass(class{constructor(o){_(this,"placeholders");this.placeholders=V.createDeco(o)}update(o){this.placeholders=V.updateDeco(o,this.placeholders)}},{decorations:o=>o.placeholders,provide:o=>v.atomicRanges.of(t=>{var e;return((e=t.plugin(o))==null?void 0:e.placeholders)||T.none})}),F=new B({regexp:/\{\{(.+?)\}\}/g,decoration:o=>T.replace({widget:new he(o[1])})});class he extends P{constructor(e){super();_(this,"text","");e&&(this.text=e)}eq(e){return this.text==e.text}toDOM(){let e=document.createElement("span");return this.text&&(e.className="cm-fn",e.textContent=this.text),e}ignoreEvent(){return!0}}const _e=U.fromClass(class{constructor(o){_(this,"placeholders");this.placeholders=F.createDeco(o)}update(o){this.placeholders=F.updateDeco(o,this.placeholders)}},{decorations:o=>o.placeholders,provide:o=>v.atomicRanges.of(t=>{var e;return((e=t.plugin(o))==null?void 0:e.placeholders)||T.none})}),ge=v.baseTheme({".cm-tag":{paddingLeft:"6px",paddingRight:"6px",paddingTop:"3px",paddingBottom:"3px",marginLeft:"3px",marginRight:"3px",backgroundColor:"#ffcdcc",borderRadius:"4px"},".cm-fn":{color:"#01a252"}}),ve=[{label:"SUM",apply:I},{label:"IF",apply:I}];function xe(o){let t=o.matchBefore(/[s](?:u(?:m)?)?|[i](?:f)?/gi);return!o.explicit&&!t?null:{from:t?t.from:o.pos,options:ve}}const be=()=>{const o=M(""),t=q(),e=M(),s=[fe,_e,ge,v.lineWrapping,te,Y(),Z({override:[xe]}),Ce(t.value)];return{code:o,view:t,editorRef:e,init:()=>{e.value&&(t.value=new v({parent:e.value,state:ee.create({doc:o.value,extensions:s})}),setTimeout(()=>{var i;(i=t.value)==null||i.focus()},0))},destroyed:()=>{var i;(i=t.value)==null||i.destroy(),t.value=void 0},insertText:(i,f="tag")=>{if(t.value){let r=f==="tag"?`[[${i}]]`:`{{${i}}}()`;const u=t.value.state.selection;if(u.main.empty){const c=u.main.head,b=f==="tag"?c+r.length:c+r.length-1,h=t.value.state.update({changes:{from:c,to:c,insert:r},selection:{anchor:b}});t.value.dispatch(h)}else{const c=u.main.from,b=u.main.to,h=f==="tag"?c+r.length:c+r.length-1,n=t.value.state.update({changes:{from:c,to:b,insert:r},selection:{anchor:h}});t.value.dispatch(n)}setTimeout(()=>{var c;(c=t.value)==null||c.focus()},0)}}}},ye=o=>({SUM:{title:"求和",example:"SUM(数值1,数值2,...)",description:"SUM(数学成绩,语文成绩,英语成绩,...) = 各科总成绩"},AVERAGE:{title:"平均数",example:"AVERAGE(数值1,数值2,...)",description:"AVERAGE(数学成绩,语文成绩,英语成绩,...) = 平均成绩"},IF:{title:"条件判断",example:"IF(条件,真值,假值)",description:"IF(数学成绩>90,优秀,良好)"}})[o];function I(o,t,e,s){const a=`{{${t.label}}}()`,p=e+a.length-1,x=o.state.update({changes:{from:e,to:s,insert:a},selection:{anchor:p}});o.dispatch(x)}function Ce(o){return v.updateListener.of(t=>{if(t.docChanged){const e=t.state.doc.toString(),s=e==null?void 0:e.replace(/[{}\[\]]/g,"");console.log(s)}})}const Ee={class:"editor-container"},$e={class:"editor-content"},De={class:"fn"},Te={class:"fn-list"},Me={class:"fn-desc"},we={name:"Editor"},Re=D({...we,setup(o,{expose:t}){const e=J({visible:!1,paramsData:[{label:"参数1",id:"1"},{label:"参数2",id:"2"},{label:"参数3",id:"3"}],fnData:[{label:"常用函数",id:"1",children:[{label:"SUM",desc:"求和",id:"1-1"},{label:"IF",desc:"条件判断",id:"1-2"}]}],info:{}}),{view:s,editorRef:a,init:p,destroyed:x,insertText:i}=be(),f=n=>{n.children||i(`${n.id}.${n.label}`)},r=n=>{n.children||i(`${n.label}`,"fn")},u=n=>{const l=ye(n.label);l&&(e.info=l)},c=()=>{var $;const n=($=s.value)==null?void 0:$.state.doc,l=n==null?void 0:n.toString(),E=l==null?void 0:l.replace(/[{}\[\]]/g,"");console.log(E)},b=()=>{e.visible=!0,X(()=>{p()})},h=()=>{x(),e.visible=!1};return t({open:b}),(n,l)=>{const E=N,$=H("MyDialog");return C(),A($,{modelValue:e.visible,"onUpdate:modelValue":l[0]||(l[0]=L=>e.visible=L),title:"Editor",width:800,center:"","close-on-click-modal":!1,"destroy-on-close":!0,onClose:h},{footer:g(()=>[d("div",null,[m(E,{onClick:h},{default:g(()=>[...l[1]||(l[1]=[w("取消",-1)])]),_:1}),m(E,{type:"primary",onClick:c},{default:g(()=>[...l[2]||(l[2]=[w("确认",-1)])]),_:1})])]),default:g(()=>[d("div",Ee,[m(S,{class:"editor-tree",data:e.paramsData,onNodeClick:f},null,8,["data"]),d("div",$e,[d("div",{class:"editor-main",ref_key:"editorRef",ref:a},null,512),d("div",De,[d("div",Te,[m(S,{"default-expand-all":!0,data:e.fnData,onNodeClick:r,onMouseenter:u},null,8,["data"])]),d("div",Me,[m(ue,K(Q(e.info)),null,16)])])])])]),_:1},8,["modelValue"])}}}),ke=k(Re,[["__scopeId","data-v-6a7565d8"]]),Se={name:"RulesEditor"},et=D({...Se,setup(o){const t=M(),e=()=>{var s;(s=t.value)==null||s.open()};return(s,a)=>{const p=N;return C(),R("div",null,[m(p,{type:"primary",size:"default",onClick:e},{default:g(()=>[...a[0]||(a[0]=[w("编辑",-1)])]),_:1}),m(ke,{ref_key:"editor",ref:t},null,512)])}}});export{et as default};
